# K8s 自动化部署系统 - 需求文档

## 一、系统概述
本系统旨在通过可视化界面，实现 Kubernetes 集群的自动化部署与监控。  
系统将现有的安装 Shell 脚本进行封装，通过任务编排与阶段化执行，实现从节点配置到组件安装的全流程自动化。  
管理员可通过 Web 界面配置节点、模板与安装选项，并实时监控安装进度。

---

## 二、系统功能结构
系统核心模块包括：
1. [任务管理](#1-任务管理)
2. [模板配置](#2-模板配置)
3. [执行与监控](#3-执行安装及过程监控)

未来扩展模块：
- 系统设置（日志路径、认证、凭证管理）
- 用户与权限管理（多用户、角色控制）
- AI 辅助模块（自动生成模板、参数推荐）

---

## 1. 任务管理

### 功能目标
用于创建、编辑和管理集群安装任务。  
每个任务代表一次完整的集群部署过程，包含节点信息、共享存储配置、可选组件等参数。

### 功能点清单

| 功能项   | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 新增任务 | 提供“新增”按钮，创建新的安装任务，填写任务名称、描述等基本信息。 |
| 编辑任务 | 提供“详情”按钮，可进入任务详情页，编辑任务配置。             |
| 删除任务 | 支持删除未执行或执行失败的任务（需二次确认）。               |
| 克隆任务 | 可复制已有任务生成新任务，方便重复部署。                     |
| 状态显示 | 展示任务状态（未执行 / 执行中 / 成功 / 失败 / 已取消）。     |

### 任务详情页功能

| 功能项       | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| 节点配置     | 新增、编辑、删除节点信息，包括节点 IP、用户名、密码（或私钥）。 |
| 共享存储配置 | 配置共享存储 IP 及路径，用于集群共享目录（如 NFS）。         |
| 组件选择     | 可选安装组件（如下拉框/复选框）：Elasticsearch、Loki 等。    |
| 验证连接     | 支持节点 SSH 连通性测试按钮，验证节点配置有效性。            |
| 保存与校验   | 修改后可保存任务配置，并执行配置合法性校验。                 |

---

## 2. 模板配置

### 功能目标
用于管理部署模板信息，模板包含安装参数和 YAML 文件，可通过节点信息动态渲染。

### 功能点清单

| 功能项       | 说明                                                         |
| ------------ | ------------------------------------------------------------ |
| 新增模板     | 提供“新增”按钮，可上传或创建模板信息（名称、描述、版本）。   |
| 查看模板     | 提供“详情”按钮，查看模板内容（如 YAML 文件内容）。           |
| 编辑模板     | 编辑模板基本信息或 YAML 内容。                               |
| 刷新模板     | 根据任务配置（如节点 IP、存储路径）自动刷新模板中变量值。    |
| 模板预览     | 显示模板渲染后的实际 YAML 文件内容。                         |
| 模板变量支持 | 模板中可引用占位符，如 `{{MASTER_IP}}`、`{{STORAGE_PATH}}` 等。 |

---

## 3. 执行安装及过程监控

### 功能目标
负责任务的执行、阶段化脚本调度与实时监控。  
系统应支持对每个阶段和每台服务器的执行进度进行展示和日志跟踪。

### 功能点清单

| 功能项       | 说明                                                     |
| ------------ | -------------------------------------------------------- |
| 执行任务     | 在任务列表中点击“执行”按钮，启动安装流程。               |
| 分阶段展示   | 显示安装流程分为 19 个阶段，每个阶段显示进度与结果。     |
| 节点进度展示 | 每台节点单独显示当前阶段、状态（执行中 / 成功 / 失败）。 |
| 实时日志     | 支持查看脚本输出日志（tail 模式实时更新）。              |
| 阶段重试     | 某阶段失败后可选择“重试本阶段”或“跳过继续执行”。         |
| 停止任务     | 支持中途终止任务执行（需确认）。                         |
| 执行记录     | 所有任务执行过程与结果写入数据库，支持导出与审计。       |

### 安装阶段定义

系统默认包含 19 个安装阶段，对应 19 个 Shell 脚本（顺序执行）：

| 阶段编号 | 阶段名称           | 脚本说明                        |
| -------- | ------------------ | ------------------------------- |
| 1        | SSH证书分发        | 分发公私钥，实现免密登录        |
| 2        | 配置环境变量       | 设置环境变量与依赖路径          |
| 3        | 安装Docker         | 安装 Docker 并启动服务          |
| 4        | 安装镜像仓库       | 部署本地或远程镜像仓库          |
| 5        | 安装kubelet依赖    | 安装 kubelet 所需依赖包         |
| 6        | 初始化集群         | 初始化主控节点的 Kubernetes     |
| 7        | 控制节点加入集群   | 将控制节点加入主控集群          |
| 8        | 工作节点加入集群   | 将 worker 节点加入集群          |
| 9        | 修改apiserver      | 更新 apiserver 配置             |
| 10       | 安装CNI            | 安装容器网络插件（CNI）         |
| 11       | 安装NFS            | 部署 NFS 存储服务               |
| 12       | 安装Kubemate       | 安装 Kubemate 服务              |
| 13       | 安装Elasticsearch  | 部署 Elasticsearch 集群（可选） |
| 14       | 安装Skywalking     | 部署 Skywalking 监控（可选）    |
| 15       | 安装Loki           | 部署 Loki 日志系统（可选）      |
| 16       | 安装Traefik        | 部署 Traefik Ingress 控制器     |
| 17       | 安装Prometheus     | 部署 Prometheus 监控组件        |
| 18       | 安装Metrics Server | 部署 Metrics Server             |
| 19       | 安装Redis Sentinel | 部署 Redis Sentinel 服务        |

### 进度与状态定义
- **未开始**：阶段未执行  
- **执行中**：脚本正在运行  
- **成功**：脚本执行成功（退出码 0）  
- **失败**：脚本执行失败（退出码非 0）  
- **跳过**：阶段被用户手动跳过  

---

## 四、非功能性需求

### 1. 安全性
- 所有节点凭证（用户名/密码/SSH密钥）需加密存储。
- 执行脚本在独立容器/隔离环境中运行。
- 执行日志中需自动脱敏密码信息。

### 2. 审计与记录
- 所有任务执行、模板刷新、配置修改需记录操作人、时间、状态。
- 支持导出任务日志与安装报告。

### 3. 可扩展性
- 阶段流程应支持配置化扩展，可新增或调整执行顺序。
- 模板支持版本管理。
- 支持插件机制，用于集成新组件（如 AI 辅助配置）。

### 4. 性能要求
- 支持同时管理至少 10 个任务并发执行。
- 单节点任务日志实时刷新延迟 ≤ 3 秒。

---

## 五、界面概要（简要）

| 模块       | 页面                                     | 主要元素                               |
| ---------- | ---------------------------------------- | -------------------------------------- |
| 任务管理   | 任务列表页                               | 搜索、新增、详情、删除、执行、状态显示 |
| 任务详情   | 节点列表、共享存储、组件选择、保存       |                                        |
| 模板配置   | 模板列表、新增、详情、刷新、预览         |                                        |
| 执行与监控 | 实时日志、阶段进度、节点状态、重试、终止 |                                        |

---

## 六、后续可扩展功能（规划）

- **安装向导模式**：以引导流程创建任务。
- **AI 辅助推荐**：根据集群规模与用途，自动推荐组件模板。
- **多集群管理**：统一管理多套 Kubernetes 集群。
- **备份与回滚**：支持任务导出、模板快照与版本回滚。
- **API 接口**：开放 RESTful / GraphQL API，供外部系统集成。

---

## 七、版本规划（建议）

| 版本 | 目标          | 主要特性                             |
| ---- | ------------- | ------------------------------------ |
| v1.0 | MVP可视化部署 | 任务管理 + 模板配置 + 执行与监控     |
| v1.1 | 稳定版        | 日志优化 + 权限系统 + 模板变量化     |
| v1.2 | 智能版        | 引入 AI 模板推荐 + 自动化诊断        |
| v2.0 | 企业版        | 多用户、多集群管理 + RBAC + 审计报告 |

---

## 八、系统角色与权限（预留）

| 角色     | 权限                     |
| -------- | ------------------------ |
| 管理员   | 所有操作、系统配置       |
| 运维人员 | 创建、执行任务、查看日志 |
| 只读用户 | 查看任务与日志           |

---

## 九、技术接口预留
- 与 Kubernetes API 对接：任务执行由系统后端调用 K8s Job/Pod 执行脚本。  
- 与 Git 仓库对接：模板文件可托管在 Git 仓库，实现版本追踪。  
- 与 AI 模型对接：未来支持智能参数补全与错误诊断。  

---