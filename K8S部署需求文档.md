# 🧠 K8s 集群一键部署系统 - 需求文档

## 一、系统概述

本系统通过图形化界面实现 **Kubernetes 集群的自动化部署、模板管理及过程监控**。
 用户可通过页面操作完成节点配置、参数填写，并在独立监控界面中实时查看安装日志与执行进度。

系统基于已有 Shell 安装脚本封装，旨在：

> 让 Kubernetes 部署从繁琐的命令操作，变为一键执行、可视化监控的过程。

------

## 二、功能模块概述

------

### 1. 任务管理模块

用于创建、配置及管理 Kubernetes 集群的安装任务。

#### 功能点

##### （1）任务列表

- 展示所有任务（任务名称、状态、创建时间、创建人等）。
- 提供以下操作：
  - ➕ **新增任务**：创建新的集群安装任务
  - 🔍 **查看详情**：进入任务详情页，配置节点与参数
  - 🗑 **删除任务**：删除任务记录

------

##### （2）任务详情页功能

用于配置任务对应的安装参数，与 Shell 脚本变量一一对应。

> 所有字段均为 **必填项**（前端需校验）。

| 配置项                                   | 描述                                                         | 默认值          | 校验规则                                |
| ---------------------------------------- | ------------------------------------------------------------ | --------------- | --------------------------------------- |
| **节点信息**                             | 页面中可直接新增节点（表格形式展示）                         | —               | 至少添加一个节点，字段不能为空          |
| 节点字段                                 | - 节点别名 - IPv4 地址 - IPv6 地址 - 是否为管理平面节点（布尔选项） | —               | 每项必填                                |
| **工作路径**                             | 对应脚本变量 `workspace`                                     | `/data`         | 必填，校验路径格式                      |
| **共享存储服务 IP 或域名**               | 对应脚本变量 `nfs_server_ip`                                 | —               | 必填，校验为合法 IPv4 / IPv6 / 域名格式 |
| **共享存储路径**                         | 对应脚本变量 `nfs_path`                                      | —               | 必填，校验路径格式                      |
| **是否安装镜像仓库**                     | 是否部署私有镜像仓库                                         | 否              | 必选（是 / 否）                         |
| **镜像仓库地址**                         | 对应脚本变量 `registry_address`                              | `registry:5000` | 必填，校验地址格式                      |
| **是否安装 Elasticsearch 与 SkyWalking** | 控制是否安装日志与链路追踪组件                               | 否              | 必选（是 / 否）                         |
| **是否安装 Loki**                        | 控制是否安装日志系统                                         | 否              | 必选（是 / 否）                         |
| **是否安装 Prometheus**                  | 控制是否安装监控系统                                         | 否              | 必选（是 / 否）                         |
| **是否安装 Redis（哨兵模式）**           | 控制是否安装高可用 Redis 集群                                | 否              | 必选（是 / 否）                         |

------

### 2. 模板配置模块

用于管理 Kubernetes 组件的 YAML 模板文件，并支持与任务参数联动。

#### 功能点

- **模板列表**
  - 展示模板名称、描述、更新时间
  - 提供以下操作：
    - ➕ **新增模板**
    - 🔍 **查看详情**（展示 YAML 文件内容）
    - 🔄 **刷新模板**（根据任务详情自动更新 IP、路径等变量）

------

### 3. 执行与监控模块

用于选择任务、执行安装流程、实时监控执行状态与日志输出。

#### 功能点

##### （1）任务选择

- 可选择来自「任务管理模块」中创建的部署任务。
- 展示任务名称、状态、创建时间、任务描述等信息。
- 操作：
  - ▶️ **执行安装任务**
  - 🔄 **重新执行失败阶段**
  - 🧹 **清理历史执行记录**

------

##### （2）安装过程监控

- 实时展示每个阶段的执行状态与日志输出。
- 支持 WebSocket / SSE 实时推送前端日志。
- 日志按节点与阶段分组显示。

###### 安装流程阶段（共 19 阶段）

1. SSH 证书分发
2. 配置环境变量
3. 安装 Docker
4. 安装镜像仓库
5. 安装 kubelet 依赖
6. 初始化集群
7. 控制节点加入集群
8. 工作节点加入集群
9. 修改 API Server
10. 安装 CNI 插件
11. 安装 NFS
12. 安装 Kubemate
13. 安装 Elasticsearch
14. 安装 SkyWalking
15. 安装 Loki
16. 安装 Traefik
17. 安装 Prometheus
18. 安装 Metrics Server
19. 安装 Redis Sentinel

------

##### （3）执行状态与日志展示

- 每阶段状态显示：
  - ⏸ 未开始
  - 🔄 进行中
  - ✅ 成功
  - ❌ 失败
- 支持以下能力：
  - 实时日志输出（自动滚动）
  - 节点级日志查看（按节点展开）
  - 阶段日志查看（按安装阶段切换）
  - 错误阶段高亮显示
  - 单阶段重试 / 全任务重试
  - 📄 **查看日志**：可查看历史任务的执行日志（含时间、节点、阶段）
  - ⬇️ **导出日志**：以文本或压缩包形式下载保存

------

## 三、系统设计约束与扩展规划

#### 当前设计约束

- 系统执行层基于 Shell 脚本封装执行
- 每个任务拥有独立的日志与执行状态
- 所有任务与模板信息存储于数据库（推荐使用 MySQL / PostgreSQL）

#### 后续扩展规划

- 用户与权限管理（多租户隔离）
- 模板版本控制
- 任务导出 / 导入
- 与企业级工具集成（Harbor、GitLab、Jenkins 等）
- AI 智能诊断（自动分析脚本错误、提供修复建议）